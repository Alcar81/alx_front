name: Déployer Frontend Dev

on:
  push:
    branches:  
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/master' && 'prod' || 'dev' }}

    env:
      ENV: ${{ vars.ENV }}
      NETWORK: ${{ vars.NET }}_${{ vars.ENV }}
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      SSH_USER: ${{ secrets.SSH_USER }}
      DEPLOY_DIRECTORY: ${{ secrets.DEPLOY_DIRECTORY }}
      FRONT: ${{ vars.FRONT }}
      NGINX: ${{ vars.NGINX }}
      CONTAINER_NAME: ${{ vars.FRONT }}_${{ vars.NGINX }}_${{ vars.ENV }}
      FRONTEND_PORT: 3001

    steps:
      - name: 1 - Afficher les variables générées
        run: |
          echo "Environnement : $ENV"
          echo "Réseau Docker : $NETWORK"
          echo "Répertoire de déploiement : $DEPLOY_DIRECTORY"
          echo "Nom du conteneur : $CONTAINER_NAME"
          echo "Port Frontend : $FRONTEND_PORT"

      - name: 2 - Checkout repository
        uses: actions/checkout@v3

      - name: 3 - Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: 4 - Install dependencies
        run: npm install

      - name: 5 - Build project
        run: npm run build

      - name: 6 - Start SSH agent and add key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          eval $(ssh-agent -s)
          echo "$SSH_PRIVATE_KEY" > /tmp/git_id_rsa
          chmod 600 /tmp/git_id_rsa
          ssh-add /tmp/git_id_rsa
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          ssh-keyscan -p ${SSH_PORT} -H ${SERVER_IP} >> ~/.ssh/known_hosts

      - name: 7 - Gérer le réseau Docker
        run: |
          ssh -p $SSH_PORT -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /tmp/git_id_rsa $SSH_USER@$SERVER_IP "
            docker network create $NETWORK || true
          "

      # Étape 8.1 : Sauvegarder le répertoire de déploiement (si nécessaire)
      - name: 8.1 - Backup deployment directory
        run: |
          ssh -p $SSH_PORT -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /tmp/git_id_rsa $SSH_USER@$SERVER_IP "
            [ -d $DEPLOY_DIRECTORY ] && cp -r $DEPLOY_DIRECTORY ${DEPLOY_DIRECTORY}_backup || echo 'No directory to backup'
          "

      # Étape 8.2 : Vérifier les fichiers avant synchronisation
      - name: 8.2 - Check destination before sync
        run: |
          ssh -p $SSH_PORT -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /tmp/git_id_rsa $SSH_USER@$SERVER_IP "
            [ -d $DEPLOY_DIRECTORY ] && ls -al $DEPLOY_DIRECTORY || echo 'No files to list'
          "

      # Étape 8.3 : Synchroniser les fichiers
      - name: 8.3 - Synchronize files to server
        run: |
          mkdir -p build_with_config
          cp -R build/* build_with_config/
          cp package.json package-lock.json build_with_config/
          rsync -avz \
            --exclude='.env' \
            --exclude='node_modules/' \
            build_with_config/ ${SSH_USER}@${SERVER_IP}:${DEPLOY_DIRECTORY} -e "ssh -p ${SSH_PORT} -o IdentitiesOnly=yes -i /tmp/git_id_rsa"
          rm -rf build_with_config

      # Étape 8.4 : Vérifier les fichiers après synchronisation
      - name: 8.4 - Check destination after sync
        run: |
          ssh -p $SSH_PORT -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /tmp/git_id_rsa $SSH_USER@$SERVER_IP "
            ls -al $DEPLOY_DIRECTORY
          "

      - name: 9 - Install dependencies on server
        run: |
          ssh -p $SSH_PORT -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /tmp/git_id_rsa $SSH_USER@$SERVER_IP "
            cd $DEPLOY_DIRECTORY && [ ! -d 'node_modules' ] && npm install || echo 'Dependencies already installed.'
          "

      - name: 10 - Restart Frontend Container
        run: |
          ssh -p $SSH_PORT -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /tmp/git_id_rsa $SSH_USER@$SERVER_IP "
            docker ps -a --filter \"name=$CONTAINER_NAME\" --format '{{.Names}}' | grep -w \"$CONTAINER_NAME\" && docker stop $CONTAINER_NAME || true &&
            docker ps -a --filter \"name=$CONTAINER_NAME\" --format '{{.Names}}' | grep -w \"$CONTAINER_NAME\" && docker rm $CONTAINER_NAME || true
            docker run -d --name $CONTAINER_NAME \
              --network $NETWORK \
              -p $FRONTEND_PORT:80 \
              -v $DEPLOY_DIRECTORY:/usr/share/nginx/html \
              nginx:alpine
          "

      - name: 11 - Health Check
        run: |
          curl --max-time 10 -I http://${SERVER_IP}:${FRONTEND_PORT} || exit 1
